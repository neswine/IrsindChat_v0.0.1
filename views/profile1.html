<!DOCTYPE html>
<html lang="en">
<head>
	<style>	
		#search_listings{
			display: none;
		}

		#their{
			position:relative;
    			width:200px; 
			height:305px;
			     		
		}

		#my-video{
			position:relative;       
     			width:30%;       
     			border:2px solid blue;
     			display:block;
     			z-index:1;  	
		}
		
		#videochat-tab {
   			 top: 30%;
    			left: 50%;
    			width:30em;
    			height:27em;
    			margin-top: -9em; /*set to a negative number 1/2 of your height*/
    			margin-left: -15em; /*set to a negative number 1/2 of your width*/
    			border: 1px solid #ccc;
    			background-color: #f3f3f3;
    			position:fixed;
			display:none;
		}
	
	</style>
	<meta charset="utf-8">
	<meta name="description" content="">
		<title>Knoldus Login Form</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/stylee.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	 <link href="/css/home.css" rel="stylesheet">
	
 	
	<script src = "/js/jquery-1.10.2.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
	<script>
	
		var peer = new Peer({ key: 'lwjd5qra8257b9', debug: 3});
		//var peer = new Peer({ key: 'lwjd5qra8257b9', debug: 3});
 		var friendlist ={};
		//connect to the port 8080
  		var socket = io.connect('http://localhost:8080');
		//sends the first name of the user that has to searched
  		socket.on('connect', function(){
			<% for(var i=0; i<friendss.length; i++) { %>
				$('#pending-requests').append('<div id="add_friend">'+"<%= friendss[i] %>"+' has requested you to add.            <a href="/profile1" onclick="add_request(\''+ "<%= friendss[i] %>" +'\',\''+ "<%= user._id %>" +'\',\''+ "<%= user.user.firstname %>" +'\')">Add</a>                     <a href="#" onclick="delete_request(\''+ "<%= friendss[i] %>" +'\')">Cancel</a></div><br>');			
			<% } %>
			socket.emit('adduserr', "<%= user.user.firstname %>","<%= user._id %>");
			//stores the value of friends list of the corresponding user into the hash friendlist
			<% for(var i=0; i<friends.length; i++) { %>
				var str ="<%= friends[i] %>"
				friendlist[str] = str
			<% } %>
  		});

		function add_request(friendname,userid, username){
			socket.emit('add new friend', friendname, userid, username);
			$('#add_friend').fadeOut(800);	
		}
			
		function delete_request(friendname){
			socket.emit('delete request', friendname,"<%= user._id %>","<%= user.user.firstname %>");
			//$('#cancel_request').fadeOut(800);		
		}	

		//update the friends list after adding him
  		socket.on('updateuserrs', function(data) {
  			$('#users').empty();
			var html = '<div style="background-color:#A8A8A8; height:30px; width:100%;padding:1px; border: 1px solid #404040 "><h4 style="font-family:Exo; color:black;" align="center">Friend List</h4></div> <ul><% for(var i=0; i<friends.length; i++) { %><li><a  style="font-family:Exo" href="#" >'
    			$.each(data, function(key, value) {
				var str = "<%= friends[i] %>";
				if(key =="<%= friends[i] %>") {
					if(html.indexOf(str) != -1){
						html += ''
					}else{
						html += '<%= friends[i] %>'
					}	
   				}else{
					if(html.indexOf(str) != -1){
						html += ''
					}else{
						html += '<%= friends[i] %>'
					}	
				}
			});
			html +=  '</a></li><% } %> </ul>'
			$('#users').append(html)
  		});		
		
  	$(function() {
	$('#search_btn').click(function () {
		$('#search_listings').show();
		$('#statuses').hide();
		$('#status').hide();
		alert('workin');
		if($('#srch_fld').val()!="") {
			socket.emit('user_search',$('#srch_fld').val(),0);
		} 
	});
	$('#srch_fld').keypress(function(e){
        if(e.which == 13){
			e.preventDefault();
		    $('#search_btn').click();
        }
    });
	socket.on('search_results',function (firstname,lastname,username,address,email,city,state,country,append) {
		if(append==0) {
			$('#search_listings').empty();	
		}
			
			$('#search_listings').append('<div id="" class="users"><div class="user_thumb"><img src="/img/img.png"></div><div class="user_dtls"><span id="more_details" class="User_name">'+firstname+' '+lastname+'</span><span  class="Usr_name">Username : '+username+'</span><span class="User_adr">Address : '+address+'</span><div id="add_details" style="display:none;" ><span class="User_adr">Email : '+email+'</span><span class="User_adr">City : '+city+'</span><span class="User_adr">State : '+state+'</span><span class="User_adr">Country : '+country+'</span></div><button onclick="friendrequest(\''+firstname+'\',\''+address+'\')" class="add_btn">Add</button></div></div>').children(':last').hide().fadeIn("slow");
		
	});
	socket.on('search_view_more',function (view_more) {
		$("#search_listings:last-child").append(view_more).fadeIn("slow");;
	});
	socket.on('search_msg',function (msg) {
		$('#search_listings').empty();	
		$('#search_listings').append(msg).children(':last').hide().fadeIn("slow");
	});

});
$(document).on('click', '#more_details', function(){ 
     $(this).closest('.user_dtls').children('#add_details').slideToggle("slow");
 });
function view_more_results(search_text,limit) {
	if(search_text!=""&&limit!="") {
		$('#view_more').remove();
		socket.emit('user_search',search_text,limit);
	}
}

	$('#search-query').keypress(function(e){
		$('#search_result').empty();	
	});	

	var peerid = {};
	var friendsonline = {};
	var socket = io.connect();

	socket.on('search result', function(name, add){
		$('#search_result').append('<div><a id="namerequest">' + name + ', ' + add + '</a>'+ ' &nbsp;    ' +'<a href="#" id="search-result" onclick="friendrequest(\''+name+'\',\''+add+'\')">Add</a></div>'); 	
	});

	function friendrequest(name, add){
		socket.emit('friend request',"<%= user._id %>", name, add, "<%= user.user.firstname %>");
		$('#namerequest').fadeOut(800);
		$('#search-result').fadeOut(800);	
	}

	socket.on('friend request', function(friendname, friendadd, username){
		var ids = "add"+friendname;
		$('#friendrequest').append('<div id="ids">'+ username +' has requested to add you.    <a href="#" id="add" onclick="addrequest(\''+ username +'\',\''+ "<%= user._id %>" +'\',\''+ "<%= user.user.firstname %>" +'\',\''+ids+'\')">Add</a>      <a id="cancel" onclick="deleterequest()">Cancel</a>');	
	});
	
	function addrequest(friendname,userid, username,ids){
		location.reload();
		socket.emit('add new friend', friendname, userid, username);
		$(ids).fadeOut(800);	
	}
	
	function deleterequest(friendname){
		socket.emit('delete request', friendname,"<%= user._id %>","<%= user.user.firstname %>");
		//$('#cancel_request').fadeOut(800);		
	}

	//sends the first name of the user that logins
	socket.on('connect', function(){
		peer.on('open', function(){	
			socket.emit('names' , "<%= user.user.firstname %>", peer.id);
		});
	});

	socket.on('peerid', function(data){
		$.each(data, function(key, value){
			peerid[key] = value;
			//alert(peerid[key]);					
		});
	});
	
	//shows online friends from his friendlist
	socket.on('friends', function(data){
		$('#online').empty();
		$.each(data, function(key ,value){
			if(value in friendlist){
				friendsonline[key] = value;
				//alert(peerid[friendsonline[key]]);	
				$('#online').append('<b><a align="left" href="#" onclick="switchName(\''+ friendsonline[key] + '\')">' + friendsonline[key] + '</a>      <a href="#" class="btn btn-info" onclick="nametotextbox(\''+ peerid[friendsonline[key]] +'\')" id="make-call" style="margin-right:.5rem">Video Call</a></b><br><a>__________________________________</a>');
			}	
		});
	});



	function nametotextbox(name){
		$('#videochat-tab').fadeIn(1600);
		$('#callto-id').val(name);
       		// Initiate a call!
       		var call = peer.call($('#callto-id').val(), window.localStream);
        	step3(call);
	}
	
	// function to generate pop-up and private chat when clicked online friend
	function switchName(key){
		socket.emit('get log data', "<%= user.user.firstname %>", key);	
		switchname(key);
	}
	
	function switchname(key){
		var wId= "to_"+key;
         	var privateDiv = document.getElementById('PrivateTab');
                var privateBox = document.createElement('div');

		$(privateBox).attr({
   			'style': 'overflow-y:none;'
  		});
 
		var privateTitle = document.createElement('div');
  		$(privateTitle).attr({
   			'style': 'width:200px; position:fixed; background-color: #A8A8A8; color: black;',
  		});
  		$(privateTitle).append("Private: "+ key);	

  		privateBox.appendChild(privateTitle);
		
		var privateChatDiv = document.createElement('div');
  		$(privateChatDiv).attr({
				'style': "overflow-y:auto;",
	   		'id': wId + "_text"
		  });
  		privateBox.appendChild(privateChatDiv);
  
  		var privateChat = document.createElement('div');
  		$(privateChat).attr({
	   		'id': wId + "_text"
		  });
  		privateChatDiv.appendChild(privateChat);
  
 		var privateBreak = document.createElement('br');
  		privateBox.appendChild(privateBreak);
	
		var privatediv = document.createElement('div');
  		$(privatediv).attr({
	   		'style': "position:fixed; float:bottom; bottom:0px;color:black;"
		  });
  		privateBox.appendChild(privatediv);
  
  		var privateText = document.createElement('input');
  		$(privateText).attr({
   			'id': wId + "_data",
   			'type': "text"
  		});
  		privatediv.appendChild(privateText);
  
  		var privateSend = document.createElement('input');
  		$(privateSend).attr({
				
   			'id': wId + "_send",
   			'type': "button",
   			'value': "Send"
  		});
  		privatediv.appendChild(privateSend);
		privateBox.appendChild(privatediv);
  
  		$(privateBox).attr({
   			'id': wId,
   			'style': 'float: right; width: 220px; height: 200px; overflow-x: auto; border-radius: 6px; border: 1px #BBB solid;',
  		});

       	privateDiv.appendChild(privateBox);

       	$(privateSend).click(function(){
			var messagetosend = $('#to_'+key+"_data").val();
			$('#to_'+key+"_text").append("<div class='bubble'><b>Me: </b>" + messagetosend + "</div>");
			$('#to_'+key+"_text").val('');
			socket.emit('sendprivatechat',"<%= user.user.firstname %>", key, messagetosend);
       });	
	}
	
	//function for private message
	socket.on('getprivatemsg', function(sender, key, message) {
  		var elem = document.getElementById('to_'+sender+"_text");
  		if(typeof(elem) != 'undefined' && elem != null){
   
  		}else{
   			switchName(sender);
  		}
	
  		var elem = document.getElementById('to_'+sender+"_text");
  		$(elem).append('<div class="bubble bubble--alt">' + message + '</div>');
        });

	socket.on('get chat history', function(from, to, mesg){
		var elem = document.getElementById('to_'+to+"_text");
  		$(elem).append('<div>' + mesg + '</div>');
	});

</script>
</head>
<body style="background-color:#E8E8E8 ;">	
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" >
  		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        			<span class="sr-only">Toggle navigation</span>
        			<span class="icon-bar"></span>
        			<span class="icon-bar"></span>
        			<span class="icon-bar"></span>
      		</button>
	  			<a class="navbar-brand" href="/profile1" ><img height="30" src="images/home.png"></a>
			</div>
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<form class="navbar-form navbar-left " style="width:40%; margin-left:25%;" role="search">
      				<div class="input-group" style="width:100%">
       					 <input type="text" id="srch_fld" placeholder="Search For People" class="form-control">
				        <span class="input-group-btn">
				          	<button class="btn btn-default" id="search_btn" type="button"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
				        </span>
		      		</div><!-- /input-group -->
		        </form>
				<ul class="nav navbar-nav navbar-right">
        			<li><a href="/profile"><img height="20" src="/image.png" name="userimage" id="userimage" alt="..." ></a></li>
        			<li><a href="/profile" ><%= user.user.firstname %>&nbsp<%= user.user.lastname %></a></li>
        			<li><a href="/logout"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span></a></li>
      			</ul> 
			</div>
		</div>
	</nav>
<div class="container" style="margin-top:50px;">
	<div class="col-md-2" style=" margin-left:30px; padding:10px; float:left; ">
		<div style="border: 1px solid #e6e6e9;	">
			<ul>
				<li><img height="50" src="/image.png" name="userimage" id="userimage" alt="..." ></li>
				<button class="btn btn-primary" data-toggle="modal" data-target="#edit">
		      		Edit
		    	</button>
			</ul>
			<ul>
				<li><a style="font-family:'Exo', sans-serif" href="/gchat">Room Chat</a></li>
			</ul>
			<ul>
				<li><a style="font-family:'Exo', sans-serif" href="/profile">View My Profile</a></li>
			</ul>
			<ul>
				<li><a style="font-family:'Exo', sans-serif" href="/videochat">Video Conference</a></li>
			</ul>
		</div>
		<br>
		<div style="margin-top:10px; height:420px; width:200px; border: 1px solid #A8A8A8;	color:black;">
			<div class="box reminder" id="users"></div>
		</div>
	</div>
	
	<div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  	<div class="modal-dialog">
			<div class="modal-content">
	      		<div class="modal-header">
	        		<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	       			 <h4 class="modal-title" style="color:black;" id="myModalLabel">Edit Profile</h4>
	      		</div>
			    <div class="modal-body">
			        <form action="/profile1" method="post" enctype="multipart/form-data" >
			          	<div class="form-group">
			           	 	<label>First Name</label>
			           	 	<input type="text" placeholder="Enter First Name" name="firstname" required="required" autofocus="autofocus" class="form-control" value="<%= user.user.firstname %>"/>
			          	</div>
				        <div class="form-group">
				            <label>Last Name</label>
				            <input type="text" placeholder="Enter Last Name" name="lastname" required="required" autofocus="autofocus" class="form-control" value="<%= user.user.lastname %>"/>
				        </div>
			          	<div class="form-group">
				            <label>User ID</label>
				            <input type="text" placeholder="Enter Your User Name" name="username" class="form-control" value ="<%= user.user.username %>" readonly>
			          	</div>
			           	<div class="form-group">
				            <label>Email</label>
				            <input type="text" placeholder="Enter Your Email Address" name="email" class="form-control" value ="<%= user.user.email %>" readonly>
			          	</div>
			          	<div class="form-group">
				            <label>Location</label>
				            <input type="text" placeholder="Enter Your Location" name="address" class="form-control" value ="<%= user.user.address %>" required>
			          	</div>
			          	<div class="form-group">
				            <label>Image</label><br><img src="/image.png" style="width:20%" name="userimage" id="userimage" class="img-rounded" />
				            <input type="file" name="file">
			          	</div>
			          	<div class="modal-footer">
				            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				            <button type="submit" class="btn btn-primary">Save changes</button>
			          	</div>
	        		</form>
	      		</div>
	    	</div>
	  	</div>
	</div>	
	
	<div class="col-md-4 " id="search_div" style="margin-top:10px; margin-left:10px; border: 1px solid #A8A8A8; background-color:#FFFFFF;">
		<<form id="status" action="">
			<p style="color:black; font-family:'Exo', sans-serif">What would you like to post <%= user.user.firstname %>&nbsp<%= user.user.lastname %>!!</p>
			<input type="text" id="status-value" class="form-control">
			<span class="input-group-btn">
				<button id="send-status" class="btn btn-default" type="button"> <span class="glyphicon glyphicon-open" aria-hidden="true"></span></button>
  			</span>
		</form>
		<div class="row users_row search_list_area" id="search_listings" ></div>
	</div>
			
	<div  style="color:black; font-family:'Exo', sans-serif" class="col-md-3" style="margin-left:10px;  border: 1px solid #A8A8A8;" >
		<div id="pending-requests"></div>
		<div id="search_result"></div>
		<div id="friendrequest"></div>		
	</div>
		
	<div class="col-md-2" style="margin-left:10px; margin-right:30px;" >
		<div style="margin-top:10px;overflow-y:auto; overflow-x:hidden;width:230px; height:240px; border: 1px solid #A8A8A8; position:fixed;color:black;">
			<div style="background-color:#A8A8A8; height:30px; width:100%;padding:1px; border: 1px solid #404040 ">
				<h4 style="font-family:'Exo', sans-serif; color:black;" align="center"> Notifications </h4>
			</div>
			<div id="status-notification"></div>
		</div>
		<br>
		<div style="margin-top:230px;overflow-y:auto;overflow-x:hidden; width:230px;height:355px; border: 1px solid #A8A8A8;position:fixed;color:black; ">
			<div style="background-color:#A8A8A8; height:30px; width:100%;padding:1px; border: 1px solid #404040 ">
				<h4 style="font-family:'Exo', sans-serif; color:black;" align="center"> Chats </h4>
			</div>
			<div id="online"></div>
		</div>
	</div>
	
	<div style="margin-left:250px; width:430px; margin-top:130px; color:black;" id="statuses"></div>	
</div>
	<div style="overflow-y:none;position:fixed;bottom:0px; right:270px;z-index:10;color:black;" id="PrivateTab" >    </div>

	<div id="videochat-tab">
		<div class="panel panel-default" style="overflow-y:scroll; ">
			<a href="#" id="closebtn" style="position:relative; align:left;" >x</a>
			<ul id="con"></ul>
  			<div class="pure-g">
      		 Video area 
  				<div class="pure-u-2-3" id="video-container">
					<div id="their">
	    					<video id="their-video" autoplay></video>
					</div>
					<div id="my">
	    					<video id="my-video" muted="true" autoplay></video>
					</div>
  				</div>
  				<!-- Steps -->
  				<div class="pure-u-1-3">
    			<!-- Get local audio/video stream -->
    				<div id="step1">
      					<p>Please click `allow` on the top of the screen so we can access your webcam and microphone for calls.</p>
      					<div id="step1-error">
    						<p>Failed to access the webcam and microphone. Make sure to run this demo on an http server and click allow when asked for permission by the browser.</p>
    						<a href="#" class="pure-button pure-button-error" id="step1-retry">Try again</a>
      					</div>
    				</div>
    				<!-- Make calls to others -->
    				<div id="step2">
      					<div class="pure-form">
        					<input type="hidden" placeholder="Call user id..." id="callto-id">
       						<a href="#" class="pure-button pure-button-success" id="make-call">Call</a>
      					</div>
    				</div>
  				</div>
  			</div>		
		</div>

	</div>
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	
	
	<script>

	$('#send-status').click(function(){
		socket.emit('status send', $('#status-value').val(), "<%= user.user.firstname %>");
		 $('#status-value').val('')	
	});

	socket.on('receive status', function(msg, name){
		//$('#statuses').append('<div>'+name+':'+msg+'</div>');
		var stat = document.getElementById('statuses');
		var box = document.createElement('div');
		
		$(box).attr({
			'style': 'margin-top:10px; background-color:#FFFFFF'
		});		
	
		var names = document.createElement('div');
		$(names).attr({
			'style': 'padding:10px;border: 1px solid #A8A8A8;'
		});
		$(names).append('<a>'+ name +'</a><br>'+msg);
		box.appendChild(names);

		stat.appendChild(box);
	});
	
	socket.on('show notification',function(name){
		
		$('#status-notification').fadeOut(800).fadeIn(200);
		$('#status-notification').append('<div><p >' + name + ' has posted something</p><a>__________________________________</a></div>');
		
	});

	$('#chat-anchor').click(function(){
		$('#chat').fadeIn(800);	
	});	
	
	$('#closebtn').click(function(){
        	window.existingCall.close();
        	step2();
		$('#videochat-tab').fadeOut(1500);
      	});
	
	// Compatibility shim
    	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

    	// PeerJS object
    	var peer = new Peer({ key: 'lwjd5qra8257b9', debug: 3});

    	peer.on('open', function(){
     		$('#my-id').text(peer.id);
    	});

	// Receiving a call
    	peer.on('call', function(call){
       	// Answer the call automatically (instead of prompting user) for demo purposes
		$('#videochat-tab').fadeIn(1500);
       		call.answer(window.localStream);
       		step3(call);
    	});	
	
	peer.on('error', function(err){
      		alert(err.message);
      		// Return to step 2 if error occurs
      		step2();
    	});

	// Click handlers setup
   	$(function(){
      		/*$('#make-call').click(function(){
        		// Initiate a call!
        		var call = peer.call($('#callto-id').val(), window.localStream);
        		step3(call);
      		});*/

      		$('#end-call').click(function(){
        		window.existingCall.close();
        		step2();
			$('#videochat-tab').fadeOut(1500);
      		});

      		// Retry if getUserMedia fails
      		$('#step1-retry').click(function(){
        		$('#step1-error').hide();
        		step1();
      		});

      	// Get things started
      		step1();
    	});

	function step1 () {
      		// Get audio/video stream
      		navigator.getUserMedia({audio: true, video: true}, function(stream){
        	// Set your video displays
        	$('#my-video').prop('src', URL.createObjectURL(stream));
        	window.localStream = stream;
        	step2();
      		}, function(){ $('#step1-error').show(); });
    	}

    	function step2 () {
      		$('#step1, #step3').hide();
      		$('#step2').show();
    	}

    	function step3 (call) {
      		// Hang up on an existing call if present
      		if (window.existingCall) {
        	window.existingCall.close();
     	}

	// Wait for stream on the call, then set peer video display
      	call.on('stream', function(stream){
        	$('#their-video').prop('src', URL.createObjectURL(stream));
      	});

	// UI stuff
      	window.existingCall = call;
      	call.on('close', step2);
      	$('#step1, #step2').hide();
      		$('#step3').show();
    	}
	$('#videochat-tab').hide();	

	</script>
</body>
</html>
